<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>projectHub</title>
    <link rel="stylesheet" type="text/css" href="chatStyle.css"/>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.5.6/firebase.js"></script>
    <script>
    var config = {
      apiKey: "AIzaSyAzdyStJSvK2g5poM_TS9VC5jSaiQRCEyY",
      authDomain: "comp1930-project.firebaseapp.com",
      databaseURL: "https://comp1930-project.firebaseio.com",
      projectId: "comp1930-project",
      storageBucket: "comp1930-project.appspot.com",
      messagingSenderId: "724816316887"
    };
    firebase.initializeApp(config);
    </script>



  </head>
  <body>
    <div id='header'>
      <span id='room'>COMP-1930 Project Room Name</span>
      <a id='logout' class='topButton' href='../index.html'>Logout</a>
      <a id='settings' class='topButton' href='test'>Settings</a>
      <span id='profileName'>Username</span>
      <img id='profileImage' src='./images/profile-blue-background.png' alt='A profile image'>
    </div>

    <div id='sidebar'>
      <a id='exit' class='sideButton' href='../main.html'><img id='exitImage' src='./images/exit.png'>Exit Room</a>
      <a id='agenda' class='sideButton' href='../agenda/index.html'>Agenda</a>
      <a id='chat' class='sideButton' href='./index.html'>Chat</a>
    </div>

    <div id='main'>
      <p id='loading'>Loading...</p>


    </div>

    <div id='footer'>
      <form id='chatForm' autocomplete="off">
        <input id='chatInput' type='text' placeholder='Type here...'>
      </form>
      <img id='send' src='./images/send.png'>
    </div>

    <script>

    //Defining firebase variables
    var messageTest = firebase.database().ref('messageTest');
    var messageCount = firebase.database().ref('messageTest/messageCount');
    var messages = firebase.database().ref('messageTest').child('messages');
    var currentUserID;
    var currentUserName;

    var messageProcessing;



    //Store the current user's display name and ID in local variables
    setTimeout(function() {
      currentUserID = firebase.auth().currentUser.uid;
      currentUserName = firebase.auth().currentUser.displayName;
      console.log(currentUserID);
      console.log(currentUserName);
    }, 1000);
    /*
    if (currentUser) {
      console.log(currentUser.displayName);
    } else {
      console.log("No user signed in.");
    }
    */


    //Prints out messages stored in database
    function printMessages() {
      messageProcessing = true;
      messages.once('value').then(function(snapshot) {
        for (var key in snapshot.val()) {

          let messageRef = firebase.database().ref('messageTest/messages/'+key+'/message');
          let messageUserRef = firebase.database().ref('messageTest/messages/'+key+'/messageUser');
          let messageUserNameRef = firebase.database().ref('messageTest/messages/'+key+'/messageUserName');

          let messageValue;
          let messageUser;
          let messageUserName;

          let messagePromise = messageRef.once('value', function(m) {
            messageValue = m.val();
          });
          let messageUserPromise = messageUserRef.once('value', function(m) {
            messageUser = m.val();
          });
          let messageUserNamePromise = messageUserNameRef.once('value', function(m) {
            messageUserName = m.val();
          });

          Promise.all([messagePromise, messageUserPromise, messageUserNamePromise]).then(function() {
            console.log(messageValue);
            console.log(messageUser);
            console.log(messageUserName);


            if (messageUser == currentUserID) {
              var content = $("<p class='ph'>" +messageValue+ "</p>");
              var userImage = $("<img class='userImage' src='./images/profile-blue-background.png'>");
              var userName = $("<span class='userName'>Username</span>");
              var user = $("<div class='user'></div>");
              var message = $("<div class='message'></div>");
              var messageBox = $("<div class='messageBox'></div>");
            } else {
              var content = $("<p class='ph2'>" +messageValue+ "</p>");
              var userImage = $("<img class='userImage2' src='./images/profile-orange.png'>");
              var userName = $("<span class='userName2'>Username</span>");
              var user = $("<div class='user2'></div>");
              var message = $("<div class='message'></div>");
              var messageBox = $("<div class='messageBox2'></div>");
            }
            $('#main').append(message);
            $(message).append(user);
            $(message).append(messageBox);
            $(user).append(userImage);
            $(messageBox).append(userName);
            $(userName).html(messageUserName);
            $(messageBox).append(content);
            $('#loading').remove();
            $('#main').scrollTop(1E6);

          })


        }
      });
      messageProcessing = false;
    }

    setTimeout(function() {

    }, 3000);

    setTimeout(function() {
      printMessages();
    }, 1500);

/*
    messages.on('child_added', function(e) {
      if (!messageProcessing) {
        let incomingMessageKey = messages.orderByKey().limitToLast(1);
        console.log(incomingMessageKey);

      }
    });
*/

    //Prints out message sent through message input to the screen
    function sendMessage() {
      messageProcessing = true;

      var input = $('#chatInput').val();
      if (input == "") {
        return false;
      }

      messageCount.transaction(function(e) {
        return e + 1;
      });

      messages.push({
        message: input,
        messageUser: currentUserID,
        messageUserName: currentUserName
      });

      var content = $("<p class='ph'>" +input+ "</p>");
      var userImage = $("<img class='userImage' src='./images/profile-blue-background.png'>");
      var userName = $("<span class='userName'>Username</span>");
      var user = $("<div class='user'></div>");
      var message = $("<div class='message'></div>");
      var messageBox = $("<div class='messageBox'></div>");

      $('#main').append(message);
      $(message).append(user);
      $(message).append(messageBox);
      $(user).append(userImage);
      $(messageBox).append(userName);
      $(userName).html(currentUserName);
      $(messageBox).append(content);

      $('#main').scrollTop(1E6);
      $('#chatInput').val('');
      messageProcessing = false;
    }

    //Signs user out and returns them to login Page
    $('#logout').on('click', function() {
      firebase.auth().signOut();
    });

    //Sends message when send button is clicked
    $('#send').on('click', function() {
      sendMessage();
    });

    //Sends message when enter is pressed while message input field is focused on
    $('#chatInput').on('keypress', function(e) {
      if (e.keyCode == 13) {
        event.preventDefault();
        sendMessage();
      }
    });
    </script>

  </body>
</html>
