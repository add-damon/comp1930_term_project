<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>projectHub</title>
    <link rel="stylesheet" type="text/css" href="chatStyle.css"/>
    

    <script src="https://www.gstatic.com/firebasejs/5.5.6/firebase.js"></script>
    <script >
    var config = {
      apiKey: "AIzaSyAzdyStJSvK2g5poM_TS9VC5jSaiQRCEyY",
      authDomain: "comp1930-project.firebaseapp.com",
      databaseURL: "https://comp1930-project.firebaseio.com",
      projectId: "comp1930-project",
      storageBucket: "comp1930-project.appspot.com",
      messagingSenderId: "724816316887"
    };
    firebase.initializeApp(config);
    </script>



  </head>
  
  <body>
    <div id='header'>
      <span id='room'>COMP-1930 Project Room Name</span>
      <a id='logout' class='topButton' href='../index.html'>Logout</a>
      <a id='settings' class='topButton' href='test'>Settings</a>
      <span id='profileName'>Username</span>
      <img id='profileImage' src='./images/profile-blue-background.png' alt='A profile image'>
    </div>



    <div id='sidebar'>
      <!-- <a id='exit' class='sideButton' href='../main.html'><img id='exitImage' src='./images/exit.png'>Exit Room</a>
      <a id='agenda' class='sideButton' href='../agenda/index.html'>Agenda</a>
      <a id='chat' class='sideButton' href='./index.html'>Chat</a> -->
      <div class="hoverToCreate">
          <div id="sidebar_title">
            <h3>Agendas</h3> 
            <a href="#"><img id="createAgendaIcon" class="rotateOnHoveringImg functionalityIcon" src="../images/create_new_room.png" alt="Create New Group Icon"/></a>
          </div>
          
          <div id="create_agenda_modal">
            <input id="agendaDesc" class="floatClearRight" type="text" placeholder="What the task is about" size="30" required/>
            <!-- <label class="floatClearRight members">name1<input class="nameCheckbox" type="checkbox" value="name1"/></label>
            <label class="floatClearRight members">name2<input class="nameCheckbox" type="checkbox" value="name2"/></label>
            <label class="floatClearRight members">name3<input class="nameCheckbox" type="checkbox" value="name3"/></label>
            <label class="floatClearRight members">name4<input class="nameCheckbox" type="checkbox" value="name4"/></label> -->
            <label class="floatClearRight" >Due Date: <input id="dueDate" type="date" min="2018-11-21"/></label>
            <label class="floatClearRight">Due Time: <input id="dueTime" type="time" value="23:59"/></label>
            <button id="createAgendaBtn" class="floatClearRight">Create</button>
          </div>
          
          
      </div>
      <div id="agendaSpace">Loading agendas ...</div>

    </div>

    <div id='main'>
      <p id='loading'>Loading...</p>


    </div>

    <div id='footer'>
      <form id='chatForm' autocomplete="off">
        <input id='chatInput' type='text' placeholder='Type here...'>
      </form>
      <img id='send' src='./images/send.png'>
    </div>


    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    
    <script>
      //Defining firebase variables
      var database = firebase.database();
      var rootRef = database.ref();
      var messageTest = firebase.database().ref('messageTest');
      var messageCount = firebase.database().ref('messageTest/messageCount');
      var messages = firebase.database().ref('messageTest').child('messages');
      var currentUserID;
      var currentUserName;
      //var userUid = firebase.auth().currentUser.uid;
      var userUid = '9EqPuCH1fEU4siXeBZyJHSxyS8I3';//uses this for testing.
      var currentUserRef = database.ref('users/' + userUid);

      //sets the user name on the top right cornner.
      currentUserRef.once('value').then(function(snapshot) {
          var userName = snapshot.child('displayName').val();
          $('#profileName').text(userName);
      });
      //parses the url address and get the currentGroupUid.
      //!!!this is very important as the contents of this page depend on this!!!
      var currentGroupUid = getCurrentGroupUidFromUrl();

      //parses the url with delimiter ('?') and gets the groupUid.
      function getCurrentGroupUidFromUrl() {
          var url = document.location.href;
          var currentGroupUid = url.split('?')[1];
          //var currentGroupUid ='-LRoR2dwlyAUq70qYL0F';
          return currentGroupUid;
      }
      console.log('geting group uid from url: ' + currentGroupUid);

      $('#agendaSpace').text('');
      $('#create_agenda_modal').hide();

      //================retrive and append agenda section================
      //retrieves each agendaUid under a group, one at a time. It then passes the //agendaUid to the function that uses Jquery to display name dynamicly.
      database.ref('groups/' + currentGroupUid + '/agendas/').once('value').then(function(snapshot) {
        var contains = snapshot.exists()
        console.log('any data here: ' + currentGroupUid + ' '+ contains);
        if (!contains) {
          $('#agendaSpace').text('No Agendas Yet.');
          console.log('No agenda data.')
        } else {
          console.log('Start looping for agendas.')
          $('#agendaSpace').text('');
          snapshot.forEach(function(childSnapshot) {
          var uid = childSnapshot.key;
          retrieveAgendaInfo(uid);
        });
        }

      });

      //var ref = database.ref('agendas').orderByChild('dueDate');
      function retrieveAgendaInfo(agendaUid) {
        database.ref('agendas/' + agendaUid).once('value').then(function(snapshot) {
          console.log(agendaUid);
          var dataObj = {
            //assignedTo: snapshot.child('assignedTo').val(),
            description: snapshot.child('description').val(),
            dueDate: snapshot.child('dueDate').val(),
            dueTime: snapshot.child('dueTime').val(),
          };
          console.log('agendas Retieved..');
          console.log('Retrieved obj: ' + dataObj);
          addAAgendaList(agendaUid, dataObj);
        });
      }
      //================end of the section================



      //=================dynamic group members listing section=============
      //retrieves each memberUid under a group, one at a time. It then passes the //memberUid to the function that uses Jquery to display name dynamicly.
      database.ref('groups/' + currentGroupUid +'/memberInfo').once('value').then(function(snapshot) {
        var contains = snapshot.exists()
        console.log('any member here: ' + currentGroupUid + ' '+ contains);
        if (!contains) {
          console.log('No group member data.')
        } else {
          console.log('Start looping for group members.')
          snapshot.forEach(function(childSnapshot) {
            var memberUid = childSnapshot.key;
            console.log('memberUid: '+ memberUid);
            retrieveGroupMemberName(memberUid);
          });
        }


      });

      //accepts a uid of each member under a group. it then uses the uid to retrieve 
      //and store the displayName under that uid. finally, it adds that displayName
      //into the user list to whom a task can be assign.
      function retrieveGroupMemberName(uid) {
        database.ref('users/' + uid).once('value').then(function(snapshot) {
          var memberName = snapshot.child('displayName').val();
          console.log('member name: '+ memberName);
          var newLabel = $('<label></label>');
          newLabel.text(memberName);
          newLabel.addClass('floatClearRight members');
          var newCheckbox = $('<input/>');
          newCheckbox.attr('value', uid);
          console.log('input value: '+ uid)
          newCheckbox.attr('type', 'checkbox');
          newCheckbox.addClass('nameCheckbox');
          newLabel.append(newCheckbox);
          $('#agendaDesc').after(newLabel);
          console.log('group member: ' + uid + ' Retieved..');
        })
      }
      //========================end of a section======================


      //=======================button handling section================
      //hover the plus sign will show the interface for creating an agenda.
      $("#createAgendaIcon").mouseover(function() {
        $('#createAgendaIcon').css('transform', 'rotate(135deg)');
        $("#create_agenda_modal").slideDown();
      });

      //click the plus sign to close the interface,
      $('#createAgendaIcon').click(function() {
        $('#createAgendaIcon').css('transform', 'rotate(-90deg)');
        $("#create_agenda_modal").slideUp();
      });
      //========================end of a section======================


    //==================create and update agenda info section====================
    //clicks the create button on the create agenda modal will write all the value
    //in the input boxes to the database and hides the interface.
    $('#createAgendaBtn').click(function getAgendaInfo() {
      var agendaDescription = $('#agendaDesc').val();
      var agendaDueDate = getCurrentDate($('#dueDate').val(), false);
      var agendaDueTime = $('#dueTime').val();
      //prefix will be added to the beginning of a random generated key.
      //helps to sort the agenda according to due time.
      var prefix = getCurrentDate($('#dueDate').val(), true) + agendaDueTime;
      var assignedTo = {};
      //store values of the checked box in 'assigned' object.
      $('.nameCheckbox:checked').each(function iterator(){
        assignedTo[$(this).val()] = true;
      });
      var data ={
        agendaDescription: agendaDescription,
        agendaDueTime: agendaDueTime,
        agendaDueDate: agendaDueDate,
      }
      updatingANewAgenda(currentGroupUid, agendaDescription, agendaDueDate, agendaDueTime, prefix, assignedTo);

      $('#createAgendaIcon').css('transform', 'rotate(-90deg)');
      $("#create_agenda_modal").slideUp();
    });

    //accepts a json object containing all the agenda info and generates
    //a random key assigned to that agenda. lastly, updates these info under the
    //currentGroupUid, the 'agendas' node, and the users to whom the agenda is
    //assigned.
    function updatingANewAgenda(currentGroupUid, newAgenda_description, newAgenda_dateDue, newAgenda_timeDue, prefix, newAgenda_memberObj) {
      database.ref('groups/').once('value').then(function(snapshot) {
        //check if the passing in currentGroupUid exists or not.
        var contains = snapshot.child(currentGroupUid).exists();
        if (!contains) {
            console.log('Group Not Found');
        } else {
          // A new group
          var newAgendaData = {
            description: newAgenda_description,
            dueTime: newAgenda_timeDue,
            dueDate: newAgenda_dateDue,
            assignedTo: newAgenda_memberObj,
          };
          // Get a key for a new group.
          var newAgendaUid = prefix + rootRef.child('agendas').push().key;
          console.log('new key for agenda:' + newAgendaUid);
          console.log('new agenda data' + newAgendaData);
          // Write the new group's data simultaneously in the groups list and the 
          //user's group list.
          var updates = {};
          updates['agendas/' + newAgendaUid] = newAgendaData;
          updates['groups/' + currentGroupUid + '/agendas/'  + newAgendaUid] = true;
          for (var key in newAgenda_memberObj) {
            updates['users/' + key + '/agendas/'  + newAgendaUid] = true;
          }
          console.log('------>updating Agenda completed<---------');

          addAAgendaList(newAgendaUid, {agendaDescription, agendaDueTime, agendaDueTime});
          return rootRef.update(updates);
        }
      });
    }

    //accepts a date object and returns eaquavilent date in two diffenrent forms.
    //eg. 20181120 if 'digital' value is true, or Nov 20, 2018 otherwise.
    function getCurrentDate(getDate, digital) {
      var monthNames = [
        "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct",
        "Nov", "Dec"
      ];
      var currentDate = new Date(getDate);
      var date = currentDate.getDate() + 1;
      var month = currentDate.getMonth();
      var year = currentDate.getFullYear();
      if (digital == true) {
        return "" + year + (month + 1) + date;
      } else {
        return monthNames[month] + " " + date + ", " + year;
      }
    }

    //accepts
    function addAAgendaList(agendaUid, {description, dueDate, dueTime}) {
    console.log(agendaUid + description + dueDate + dueTime);
      var div_agendas = $('<div></div>');
      div_agendas.addClass('agendas');
      div_agendas.attr('id', agendaUid);
      // var h2_groupTitle = $('<h2></h2>');
      // h2_groupTitle.text("");
      //div_agendas.append(h2_groupTitle);
      //need to loop this
      var div_individualAgenda = $('<div></div>');
      div_individualAgenda.addClass('individualAgenda')
      var h4_agendaDesc = $('<h4><//h4>');
      h4_agendaDesc.addClass('agendaDesc');
      //h4_agendaDesc.text(description);
      h4_agendaDesc.text(agendaUid);
      var p_agendaDesc = $('<p></p>');
      p_agendaDesc.text("Due: ");
      p_agendaDesc.addClass('agendaDesc');
      var span_date = $('<span></span>');
      span_date.text(dueDate + " @ ");
      var span_time = $('<span></span>');
      span_time.text(dueTime);
      p_agendaDesc.append(span_date, span_time);
      div_individualAgenda.append(h4_agendaDesc, p_agendaDesc);
      div_agendas.append(div_individualAgenda);
      $('#agendaSpace').prepend(div_agendas);
    }
    //========================end of a section======================















    //Store the current user's display name and ID in local variables
    setTimeout(function() {
        currentUserID = firebase.auth().currentUser.uid;
        currentUserName = firebase.auth().currentUser.displayName;
        console.log(currentUserID);
        console.log(currentUserName);
    }, 1000);
    /*
    if (currentUser) {
      console.log(currentUser.displayName);
    } else {
      console.log("No user signed in.");
    }
    */


    //Prints out messages stored in database
    setTimeout(function() {
      messages.on('child_added', function(snapshot) {
          let key = snapshot.key;

          let messageRef = firebase.database().ref('messageTest/messages/'+key+'/message');
          let messageUserRef = firebase.database().ref('messageTest/messages/'+key+'/messageUser');
          let messageUserNameRef = firebase.database().ref('messageTest/messages/'+key+'/messageUserName');

          let messageValue;
          let messageUser;
          let messageUserName;

          let messagePromise = messageRef.once('value', function(m) {
            messageValue = m.val();
          });
          let messageUserPromise = messageUserRef.once('value', function(m) {
            messageUser = m.val();
          });
          let messageUserNamePromise = messageUserNameRef.once('value', function(m) {
            messageUserName = m.val();
          });

          Promise.all([messagePromise, messageUserPromise, messageUserNamePromise]).then(function() {
            console.log(messageValue);
            console.log(messageUser);
            console.log(messageUserName);


            if (messageUser == currentUserID) {
              var content = $("<p class='ph'>" +messageValue+ "</p>");
              var userImage = $("<img class='userImage' src='./images/profile-blue-background.png'>");
              var userName = $("<span class='userName'>Username</span>");
              var user = $("<div class='user'></div>");
              var message = $("<div class='message'></div>");
              var messageBox = $("<div class='messageBox'></div>");
            } else {
              var content = $("<p class='ph2'>" +messageValue+ "</p>");
              var userImage = $("<img class='userImage2' src='./images/profile-orange.png'>");
              var userName = $("<span class='userName2'>Username</span>");
              var user = $("<div class='user2'></div>");
              var message = $("<div class='message'></div>");
              var messageBox = $("<div class='messageBox2'></div>");
            }
            $('#main').append(message);
            $(message).append(user);
            $(message).append(messageBox);
            $(user).append(userImage);
            $(messageBox).append(userName);
            $(userName).html(messageUserName);
            $(messageBox).append(content);
            $('#loading').remove();
            $('#main').scrollTop(1E6);

          });


        });
      }, 1500);





    //Prints out message sent through message input to the screen
    function sendMessage() {


      var input = $('#chatInput').val();
      if (input == "") {
        return false;
      }

      messageCount.transaction(function(e) {
        return e + 1;
      });

      messages.push({
        message: input,
        messageUser: currentUserID,
        messageUserName: currentUserName
      });

      $('#chatInput').val('');
    }

    //Signs user out and returns them to login Page
    $('#logout').on('click', function() {
      firebase.auth().signOut();
    });

    //Sends message when send button is clicked
    $('#send').on('click', function() {
      sendMessage();
    });

    //Sends message when enter is pressed while message input field is focused on
    $('#chatInput').on('keypress', function(e) {
      if (e.keyCode == 13) {
        event.preventDefault();
        sendMessage();
      }
    });
    </script>

  </body>
</html>
